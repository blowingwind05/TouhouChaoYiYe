module bgm(
    input clk,
    input start,
    input rstn,
    input wire [15:0] frac,      
    input [2:0]speedup,
    output reg B
    );
    reg [24:1]t;
    reg [24:1]total;
    reg clk_out;

    always@(posedge clk,negedge rstn)
        if(~rstn) total<=3125000;
        // else if(speedup==1) total<=3125000;
        else if(speedup==2) total<=3125000;
        else total<=3125000;

    always@(posedge clk,negedge rstn)
        if(~rstn) begin clk_out<=0;t<=total; end
        else if(t==0) begin clk_out<=~clk_out;t<=total; end
        else begin t<=t-1; end


    reg [10:0]state;
    always@(posedge clk_out,negedge rstn)         
        if(~rstn) state<=0;
        else if(start) begin
            if(state!=608)state<=state+1;
            else state<=0;
        end
    reg [6:1]m;
    always@(*)
    if(start)
        case(state) 
        0	:m=3;
        1	:m=3;
        2	:m=3;
        3	:m=3;
        4	:m=3;
        5	:m=3;
        6	:m=3;
        7	:m=3;


        8	:m=3;
        9	:m=3;
        10	:m=3;
        11	:m=3;
        12	:m=3;
        13	:m=3;
        14	:m=3;
        15	:m=0;


        16	:m=3;
        17	:m=3;
        18	:m=3;
        19	:m=3;
        20	:m=6;
        21	:m=6;
        22	:m=6;
        23	:m=6;


        24	:m=7;
        25	:m=7;
        26	:m=7;
        27	:m=7;
        28	:m=8;
        29	:m=8;
        30	:m=8;
        31	:m=8;


        32	:m=3;
        33	:m=3;
        34	:m=3;
        35	:m=3;
        36	:m=3;
        37	:m=3;
        38	:m=3;
        39	:m=3;


        40	:m=3;
        41	:m=3;
        42	:m=3;
        43	:m=3;
        44	:m=3;
        45	:m=3;
        46	:m=3;
        47	:m=0;


        48	:m=3;
        49	:m=3;
        50	:m=3;
        51	:m=3;
        52	:m=6;
        53	:m=6;
        54	:m=6;
        55	:m=6;


        56	:m=7;
        57	:m=7;
        58	:m=7;
        59	:m=7;
        60	:m=8;
        61	:m=8;
        62	:m=4;
        63	:m=4;


        64	:m=3;
        65	:m=3;
        66	:m=3;
        67	:m=3;
        68	:m=3;
        69	:m=3;
        70	:m=3;
        71	:m=3;


        72	:m=3;
        73	:m=3;
        74	:m=3;
        75	:m=3;
        76	:m=3;
        77	:m=3;
        78	:m=3;
        79	:m=0;


        80	:m=3;
        81	:m=3;
        82	:m=3;
        83	:m=3;
        84	:m=6;
        85	:m=6;
        86	:m=6;
        87	:m=6;


        88	:m=7;
        89	:m=7;
        90	:m=7;
        91	:m=7;
        92	:m=8;
        93	:m=8;
        94	:m=8;
        95	:m=8;


        96	:m=3;
        97	:m=3;
        98	:m=3;
        99	:m=3;
        100	:m=3;
        101	:m=3;
        102	:m=3;
        103	:m=3;

        
        104	:m=3;
        105	:m=3;
        106	:m=3;
        107	:m=3;
        108	:m=3;
        109	:m=3;
        110	:m=3;
        111	:m=0;


        112	:m=3;
        113	:m=3;
        114	:m=3;
        115	:m=3;
        116	:m=6;
        117	:m=6;
        118	:m=6;
        119	:m=6;


        120	:m=7;
        121	:m=7;
        122	:m=7;
        123	:m=7;
        124	:m=8;
        125	:m=8;
        126	:m=8;
        127	:m=8;


        128	:m=3;
        129	:m=3;
        130	:m=5;
        131	:m=5;
        132	:m=6;
        133	:m=6;
        134	:m=6;
        135	:m=6;


        136	:m=3;
        137	:m=3;
        138	:m=5;
        139	:m=5;
        140	:m=6;
        141	:m=6;
        142	:m=6;
        143	:m=6;


        144	:m=3;
        145	:m=3;
        146	:m=5;
        147	:m=5;
        148	:m=6;
        149	:m=6;
        150	:m=3;
        151	:m=3;


        152	:m=8;
        153	:m=8;
        154	:m=7;
        155	:m=7;
        156	:m=6;
        157	:m=6;
        158	:m=5;
        159	:m=5;


        160	:m=2;
        161	:m=2;
        162	:m=3;
        163	:m=3;
        164	:m=5;
        165	:m=5;
        166	:m=5;
        167	:m=5;


        168	:m=2;
        169	:m=2;
        170	:m=3;
        171	:m=3;
        172	:m=5;
        173	:m=5;
        174	:m=5;
        175	:m=5;


        176	:m=3;
        177	:m=3;
        178	:m=5;
        179	:m=5;
        180	:m=6;
        181	:m=6;
        182	:m=3;
        183	:m=3;


        184	:m=10;
        185	:m=10;
        186	:m=9;
        187	:m=9;
        188	:m=8;
        189	:m=8;
        190	:m=7;
        191	:m=7;


        192	:m=3;
        193	:m=3;
        194	:m=5;
        195	:m=5;
        196	:m=6;
        197	:m=6;
        198	:m=6;
        199	:m=6;


        200	:m=3;
        201	:m=3;
        202	:m=5;
        203	:m=5;
        204	:m=6;
        205	:m=6;
        206	:m=6;
        207	:m=6;


        208	:m=3;
        209	:m=3;
        210	:m=5;
        211	:m=5;
        212	:m=6;
        213	:m=6;
        214	:m=3;
        215	:m=3;


        216	:m=8;
        217	:m=8;
        218	:m=7;
        219	:m=7;
        220	:m=6;
        221	:m=6;
        222	:m=5;
        223	:m=5;


        224	:m=2;
        225	:m=2;
        226 :m=3;
        227 :m=3;
        228	:m=1;
        229	:m=1;
        230 :m=1;
        231 :m=1;


        232	:m=17;
        233	:m=17;
        234	:m=17;
        235	:m=17;
        236	:m=15;
        237	:m=15;
        238	:m=15;
        239	:m=15;


        240	:m=16;
        241	:m=16;
        242	:m=16;
        243	:m=16;
        244	:m=17;
        245	:m=17;
        246	:m=17;
        247	:m=17;


        248	:m=1;
        249	:m=1;
        250	:m=1;
        251	:m=0;
        252 :m=1;
        253 :m=1;
        254 :m=2;
        255 :m=2;


        256	:m=3;
        257	:m=3;
        258	:m=3;
        259	:m=3;
        260 :m=3;
        261 :m=3;
        262 :m=3;
        263 :m=3;


        264	:m=3;
        265	:m=3;
        266	:m=3;
        267	:m=3;
        268 :m=2;
        269 :m=2;
        270 :m=5;
        271 :m=5;


        272	:m=6;
        273	:m=6;
        274	:m=6;
        275	:m=6;
        276 :m=6;
        277 :m=6;
        278 :m=6;
        279 :m=6;

        
        280	:m=6;
        281	:m=6;
        282	:m=3;
        283	:m=3;
        284 :m=7;
        285 :m=7;
        286 :m=8;
        287 :m=8;


        288	:m=7;
        289	:m=7;
        290	:m=7;
        291	:m=7;
        292 :m=7;
        293 :m=7;
        294 :m=7;
        295 :m=7;


        296	:m=5;
        297	:m=5;
        298	:m=5;
        299	:m=5;
        300 :m=6;
        301 :m=6;
        302 :m=6;
        303 :m=6;


        304	:m=3;
        305	:m=3;
        306	:m=3;
        307	:m=3;
        308 :m=3;
        309 :m=3;
        310 :m=3;
        311 :m=3;


        312	:m=3;
        313	:m=3;
        314	:m=3;
        315	:m=0;
        316 :m=3;
        317 :m=3;
        318 :m=5;
        319 :m=5;


        320	:m=6;
        321	:m=6;
        322	:m=6;
        323	:m=6;
        324 :m=6;
        325 :m=6;
        326 :m=6;
        327 :m=6;


        328	:m=6;
        329	:m=6;
        330	:m=6;
        331	:m=6;
        332 :m=3;
        333 :m=3;
        334 :m=5;
        335 :m=5;


        336 :m=6;
        337 :m=6;
        338 :m=6;
        339 :m=6;
        340 :m=6;
        341 :m=6;
        342 :m=6;
        343 :m=6;
        
        344 :m=6;
        345 :m=6;
        346 :m=3;
        347 :m=3;
        348 :m=7;
        349 :m=7;
        350 :m=8;
        351 :m=8;
        
        352 :m=7;
        353 :m=7;
        354 :m=7;
        355 :m=7;
        356 :m=7;
        357 :m=7;
        358 :m=7;
        359 :m=7;
        
        360 :m=8;
        361 :m=8;
        362 :m=8;
        363 :m=8;
        364 :m=9;
        365 :m=9;
        366 :m=9;
        367 :m=9;
        
        368 :m=10;
        369 :m=10;
        370 :m=10;
        371 :m=10;
        372 :m=10;
        373 :m=10;
        374 :m=10;
        375 :m=10;
        
        376 :m=10;
        377 :m=10;
        378 :m=9;
        379 :m=9;
        380 :m=8;
        381 :m=8;
        382 :m=7;
        383 :m=7;
        
        384 :m=6;
        385 :m=6;
        386 :m=7;
        387 :m=7;
        388 :m=8;
        389 :m=8;
        390 :m=8;
        391 :m=8;
        
        392 :m=7;
        393 :m=7;
        394 :m=6;
        395 :m=6;
        396 :m=5;
        397 :m=5;
        398 :m=6;
        399 :m=6;
        
        400 :m=6;
        401 :m=6;
        402 :m=6;
        403 :m=6;
        404 :m=6;
        405 :m=6;
        406 :m=6;
        407 :m=6;
        
        408 :m=6;
        409 :m=6;
        410 :m=3;
        411 :m=3;
        412 :m=6;
        413 :m=6;
        414 :m=3;
        415 :m=3;
        
        416 :m=6;
        417 :m=6;
        418 :m=7;
        419 :m=7;
        420 :m=8;
        421 :m=8;
        422 :m=8;
        423 :m=8;

        424 :m=7;
        425 :m=7;
        426 :m=6;
        427 :m=6;
        428 :m=5;
        429 :m=5;
        430 :m=10;
        431 :m=10;

        432 :m=10;
        433 :m=10;
        434 :m=10;
        435 :m=10;
        436 :m=10;
        437 :m=10;
        438 :m=10;
        439 :m=10;

        440 :m=10;
        441 :m=10;
        442 :m=9;
        443 :m=9;
        444 :m=8;
        445 :m=8;
        446 :m=7;
        447 :m=7;

        448 :m=6;
        449 :m=6;
        450 :m=7;
        451 :m=7;
        452 :m=8;
        453 :m=8;
        454 :m=8;
        455 :m=8;

        456 :m=7;
        457 :m=7;
        458 :m=6;
        459 :m=6;
        460 :m=5;
        461 :m=5;
        462 :m=10;
        463 :m=10;

        464 :m=10;
        465 :m=10;
        466 :m=9;
        467 :m=9;
        468 :m=8;
        469 :m=8;
        470 :m=9;
        471 :m=9;

        472 :m=8;
        473 :m=8;
        474 :m=7;
        475 :m=7;
        476 :m=6;
        477 :m=6;
        478 :m=5;
        479 :m=5;

        480 :m=6;
        481 :m=6;
        482 :m=7;
        483 :m=7;
        484 :m=8;
        485 :m=8;
        486 :m=8;
        487 :m=8;

        488 :m=7;
        489 :m=7;
        490 :m=6;
        491 :m=6;
        492 :m=5;
        493 :m=5;
        494 :m=6;
        495 :m=6;

        496 :m=6;
        497 :m=6;
        498 :m=6;
        499 :m=6;
        500 :m=6;
        501 :m=6;
        502 :m=6;
        503 :m=6;

        504 :m=6;
        505 :m=6;
        506 :m=3;
        507 :m=3;
        508 :m=6;
        509 :m=6;
        510 :m=3;
        511 :m=3;

        512 :m=6;
        513 :m=6;
        514 :m=7;
        515 :m=7;
        516 :m=8;
        517 :m=8;
        518 :m=8;
        519 :m=8;

        520 :m=7;
        521 :m=7;
        522 :m=6;
        523 :m=6;
        524 :m=5;
        525 :m=5;
        526 :m=10;
        527 :m=10;

        528 :m=10;
        529 :m=10;
        530 :m=10;
        531 :m=10;
        532 :m=10;
        533 :m=10;
        534 :m=10;
        535 :m=10;

        536 :m=10;
        537 :m=10;
        538 :m=9;
        539 :m=9;
        540 :m=8;
        541 :m=8;
        542 :m=7;
        543 :m=7;

        544 :m=6;
        545 :m=6;
        546 :m=7;
        547 :m=7;
        548 :m=8;
        549 :m=8;
        550 :m=8;
        551 :m=8;

        552 :m=7;
        553 :m=7;
        554 :m=6;
        555 :m=6;
        556 :m=5;
        557 :m=5;
        558 :m=10;
        559 :m=10;

        560 :m=10;
        561 :m=10;
        562 :m=9;
        563 :m=9;
        564 :m=8;
        565 :m=8;
        566 :m=9;
        567 :m=9;

        568 :m=8;
        569 :m=8;
        570 :m=7;
        571 :m=7;
        572 :m=6;
        573 :m=6;
        574 :m=5;
        575 :m=5;

        576 :m=8;
        577 :m=8;
        578 :m=9;
        579 :m=9;
        580 :m=10;
        581 :m=10;
        582 :m=10;
        583 :m=10;

        584 :m=9;
        585 :m=9;
        586 :m=10;
        587 :m=10;
        588 :m=12;
        589 :m=12;
        590 :m=13;
        591 :m=13;

        592	:m=13;
        593	:m=13;
        594	:m=13;
        595	:m=13;
        596 :m=13;
        597 :m=13;
        598 :m=13;
        599 :m=13;


        600	:m=13;
        601	:m=13;
        602	:m=13;
        603	:m=13;
        604 :m=13;
        605 :m=13;
        606 :m=13;
        607 :m=13;
        default: m=0;
        endcase
    else m=0;

    reg [27:1]q;
    always@(*)
    begin
        case(m)//降A大调
        0: q=0;
        1: q=100000000/415 ;
        2: q=100000000/466 ;
        3: q=100000000/523 ;
        4: q=100000000/554 ;
        5: q=100000000/622 ;
        6: q=100000000/698 ;
        7: q=100000000/784 ;
        8: q=100000000/831 ;
        9: q=100000000/932 ;
        10: q=100000000/1046 ;
        11: q=100000000/1109 ;
        12: q=100000000/1245 ;
        13: q=100000000/1397 ;
        15: q=100000000/311 ;
        16: q=100000000/349 ;
        17: q=100000000/392 ;
        31: q=100000000/261 ;
        32: q=100000000/293 ;
        33: q=100000000/329 ;
        34: q=100000000/349 ;
        35: q=100000000/392 ;
        36: q=100000000/440 ;
        37: q=100000000/493 ;
        38: q=100000000/523 ;
        39: q=100000000/587 ;
        40: q=100000000/659 ;
        41: q=100000000/698 ;
        42: q=100000000/740 ;
        43: q=100000000/784 ;
        44: q=100000000/880 ;
        45: q=100000000/998 ;
        46: q=100000000/1046;
        47: q=100000000/1174;
        48: q=100000000/1318;
        49: q=100000000/1396;
        50: q=100000000/1568;
        51: q=100000000/1760;
        52: q=100000000/1976;
        default:q=0;
        endcase    
    end
 
    reg [27:1]p;
    reg [27:1]tt;
    always@(posedge clk,negedge rstn)      
    begin
        if(~rstn) begin B<=0;p<=0; end
        else begin
            tt<=q;
            if(q==0||tt!=q)
            begin
                if(q==0) begin B<=0; end
                if(tt!=q) begin p<=0; end
            end
            else
            begin 
                if(p==q-1) p<=0;
                else p<=p+1;
                if(p==0) B<=1;
                if(p==q/frac) B<=0;//占空比控制音量
            end
        end
    end 
endmodule
